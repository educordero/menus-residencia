<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Menús Residencias</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    .filtros { display: flex; gap: 16px; align-items: center; margin-bottom: 1em; }
    #btnNuevoCentro { margin-left: 48px; }
    input, select { padding: 0.5em; }
    ul { padding: 0; list-style: none; }
    li { margin: 0.5em 0; }
    .menu-item a { text-decoration: none; color: blue; }
    .calendario { margin-top: 1em; }
    .semana { display: inline-block; padding: 0.5em; border: 1px solid #ccc; margin: 0.2em; cursor: pointer; }
    .semana:hover { background: #eef; }
  </style>
</head>
<body>
  <h1>Consulta de Menús por Residencia</h1>

  <div class="filtros">
    <input type="text" id="buscador" placeholder="Buscar residencia..." autocomplete="off" />
    <select id="provincia">
      <option value="">Todas las provincias</option>
    </select>
    <button id="btnNuevoCentro">➕ Añadir nuevo centro</button>
  </div>

  <div id="formularioCentro" style="display:none; margin-top:1em;">
    <input type="text" id="nuevocentro" placeholder="Nombre del centro" autocomplete="off" />
    <select id="nuevaProvincia">
      <option value="">Selecciona provincia</option>
      <option value="Barcelona">Barcelona</option>
      <option value="Lleida">Lleida</option>
      <option value="Madrid">Madrid</option>
    </select>
    <button id="guardarCentro">Guardar centro</button>
  </div>

  <ul id="resultados"></ul>
  <div id="menusCentro" style="margin-top: 2em;"></div>

  <div id="formCodigo" style="display:none; margin-top:1em;">
    <input type="password" id="codigoCentro" maxlength="4" placeholder="Introduce código (4 cifras)" autocomplete="off" />
    <button id="validarCodigo">Validar</button>
    <span id="errorCodigo" style="color: red; display: none;">Código incorrecto</span>
  </div>

  <img src="Logo.png" alt="Logo Aramark" style="position: absolute; top: 30px; right: 30px; height: 120px;">

  <script>
    let data = [];
    let ultimoCentroSeleccionado = null;

    fetch('centros.json')
      .then(r => r.json())
      .then(json => {
        validarMenusUnicosPorCentro(json);
        data = json;
        cargarProvincias();
      });

    const buscador = document.getElementById('buscador');
    const provincia = document.getElementById('provincia');
    const resultados = document.getElementById('resultados');

    buscador.addEventListener('input', filtrar);
    provincia.addEventListener('change', filtrar);

    document.getElementById('btnNuevoCentro').onclick = () => {
      document.getElementById('formularioCentro').style.display = 'block';
    };

    document.getElementById('guardarCentro').onclick = () => {
      const nombreCentro = document.getElementById('nuevocentro').value.trim();
      const provinciaCentro = document.getElementById('nuevaProvincia').value;
      if (!nombreCentro || !provinciaCentro) return alert('Debes rellenar ambos campos.');
      if (data.some(d => d.nombre.toLowerCase() === nombreCentro.toLowerCase())) return alert('Este centro ya existe.');
      data.push({ nombre: nombreCentro, provincia: provinciaCentro, menus: [] });
      cargarProvincias();
      filtrar();
      document.getElementById('formularioCentro').style.display = 'none';
      document.getElementById('nuevocentro').value = '';
      document.getElementById('nuevaProvincia').value = '';
    };

    function cargarProvincias() {
      while (provincia.options.length > 1) provincia.remove(1);
      [...new Set(data.map(d => d.provincia))].forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        provincia.appendChild(opt);
      });
    }

    function filtrar() {
      const texto = buscador.value.toLowerCase();
      const filtroProvincia = provincia.value;
      resultados.innerHTML = '';
      document.getElementById('menusCentro').innerHTML = '';
      document.getElementById('formCodigo').style.display = 'none';
      if (!texto && !filtroProvincia) return;
      data.filter(d =>
        d.nombre.toLowerCase().includes(texto) &&
        (!filtroProvincia || d.provincia === filtroProvincia)
      ).forEach(d => {
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.textContent = `${d.nombre} (${d.provincia})`;
        btn.onclick = () => pedirCodigo(d);
        li.appendChild(btn);
        resultados.appendChild(li);
      });
    }

    function pedirCodigo(centro) {
      ultimoCentroSeleccionado = centro;
      document.getElementById('menusCentro').innerHTML = '';
      document.getElementById('formCodigo').style.display = 'block';
      document.getElementById('codigoCentro').value = '';
      document.getElementById('errorCodigo').style.display = 'none';
      document.getElementById('codigoCentro').focus();
    }

    document.getElementById('validarCodigo').onclick = () => {
      if (!ultimoCentroSeleccionado) return;
      const pinIngresado = document.getElementById('codigoCentro').value.trim();
      const pinCorrecto = (ultimoCentroSeleccionado.codigo || "").trim();
      if (pinIngresado === pinCorrecto) {
        document.getElementById('formCodigo').style.display = 'none';
        mostrarCalendario(ultimoCentroSeleccionado);
      } else {
        document.getElementById('errorCodigo').style.display = 'inline';
      }
    };

    function validarMenusUnicosPorCentro(data) {
      let errores = [];
      data.forEach(c => {
        let nombres = c.menus.map(m => m.nombre.toLowerCase());
        let duplicados = nombres.filter((v, i) => nombres.indexOf(v) !== i);
        if (duplicados.length) errores.push(`Duplicados en "${c.nombre}": ${[...new Set(duplicados)].join(', ')}`);
      });
      if (errores.length) {
        alert('Errores en JSON:\n' + errores.join('\n'));
        throw new Error('Duplicados detectados');
      }
    }

    function mostrarCalendario(centro) {
      const contenedor = document.getElementById('menusCentro');
      contenedor.innerHTML = `<h2>${centro.nombre}</h2>`;
      const semanas = 5; // fijo o parametrizable
      const inicio = new Date(2025, 8, 1); // 1 sept 2025
      const divCal = document.createElement('div');
      divCal.className = 'calendario';
      for (let i = 0; i < semanas; i++) {
        let ini = new Date(inicio); ini.setDate(ini.getDate() + i * 7);
        let fin = new Date(ini); fin.setDate(fin.getDate() + 6);
        const semanaBtn = document.createElement('div');
        semanaBtn.className = 'semana';
        semanaBtn.textContent = `Semana ${i + 1} (${ini.toLocaleDateString()} - ${fin.toLocaleDateString()})`;
        semanaBtn.onclick = () => mostrarMenusSemana(centro, i + 1);
        divCal.appendChild(semanaBtn);
      }
      contenedor.appendChild(divCal);
    }

    function mostrarMenusSemana(centro, semana) {
      const ul = document.createElement('ul');
      ul.innerHTML = centro.menus.map(m => {
        const urlSem = m.url.replace('.pdf', `_sem${semana}.pdf`);
        return `<li class="menu-item"><a href="${urlSem}" target="_blank">${m.nombre} - Semana ${semana}</a></li>`;
      }).join('');
      document.getElementById('menusCentro').appendChild(ul);
    }
  </script>
</body>
</html>


